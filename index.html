<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency File Count Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        #detailsModal.hidden, .hidden { display: none; }
        .th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        .td { padding: 1rem 1rem; white-space: nowrap; font-size: 0.875rem; color: #334155; }
        .td-wrap { padding: 1rem 1rem; white-space: pre-wrap; font-size: 0.875rem; color: #475569; }
        /* Custom scrollbar for challenge tracker */
        .challenge-scroll::-webkit-scrollbar { width: 8px; }
        .challenge-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .challenge-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .challenge-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen">

    <!-- App Container -->
    <div class="container mx-auto p-4 w-full">

        <!-- Login View -->
        <div id="loginView">
            <div class="bg-white shadow-2xl rounded-xl p-6 sm:p-8 max-w-md mx-auto">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 text-center">Agency Login</h1>
                <p class="text-slate-500 text-center mt-2">Enter your email to view performance.</p>
                <div class="mt-8">
                    <input type="email" id="emailInput" class="w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500" placeholder="your.email@example.com">
                    <button id="loginBtn" class="w-full mt-4 bg-blue-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-blue-700">Login</button>
                    <div id="loginError" class="hidden mt-4 bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-md text-sm"></div>
                </div>
            </div>
            <p class="text-center text-xs text-slate-400 mt-8">Powered by RBX</p>
        </div>

        <!-- Main Dashboard View -->
        <div id="dashboardView" class="hidden">
            <!-- Header Section -->
            <header class="bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                 <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                    <div>
                        <h1 id="dashboardTitle" class="text-2xl sm:text-4xl font-extrabold text-slate-900">Performance</h1>
                        <p id="welcomeMessage" class="text-slate-600 mt-1 text-base sm:text-lg"></p>
                    </div>
                    <div id="userControls" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                        <select id="selector" class="w-full sm:w-auto p-2 border border-slate-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500">
                            <!-- Options will be populated here -->
                        </select>
                        <button id="logoutBtn" class="w-full sm:w-auto bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-300">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Results Section -->
            <div id="resultsContainer">
                <div id="loading" class="text-center py-12">
                    <div class="spinner w-12 h-12 sm:w-16 sm:h-16 border-4 border-slate-200 rounded-full mx-auto"></div>
                    <p class="mt-4 text-slate-500 text-base sm:text-lg">Fetching performance data...</p>
                </div>
                <div id="error" class="hidden bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-md" role="alert">
                    <strong class="font-bold">Data Error!</strong>
                    <span class="block sm:inline" id="errorMessage"></span>
                </div>
                
                <!-- Main Content Area -->
                <div id="mainContent" class="hidden">
                    <!-- Admin Year-End Summary -->
                    <div id="adminSummary" class="hidden mb-6"></div>
                    
                    <!-- Quarterly Analysis -->
                    <div id="quarterlyContainer" class="bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                        <h2 id="quarterlyTitle" class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Quarterly Analysis</h2>
                        <div id="quarterlyAnalysis" class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 text-center">
                            <!-- Quarterly cards will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- Admin Leaderboard -->
                    <div id="adminLeaderboard" class="hidden bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Leaderboard (Current Year)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Top 3 Overall -->
                            <div>
                                <h3 class="font-bold text-slate-600 mb-2 text-center">Top 3 Agencies (Files)</h3>
                                <ul id="topAgencies" class="space-y-2"></ul>
                            </div>
                            <!-- Top Quarterly -->
                            <div>
                                <h3 class="font-bold text-slate-600 mb-2 text-center">Top Quarterly Performer</h3>
                                <ul id="topQuarters" class="space-y-2"></ul>
                            </div>
                            <!-- Top Monthly -->
                            <div>
                                <h3 class="font-bold text-slate-600 mb-2 text-center">Top Monthly Performer</h3>
                                <ul id="topMonths" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Annual Agent Challenge Tracker -->
                    <div id="adminChallenge" class="hidden bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Annual Agent Challenge (Per File)</h2>
                        <div id="agentChallenge" class="max-h-80 overflow-y-auto space-y-3 challenge-scroll pr-2"></div>
                    </div>
                    
                    <!-- Admin Quarterly Agent Challenge Tracker -->
                    <div id="adminQuarterlyChallenge" class="hidden bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Quarterly Agent Challenge (Total Files)</h2>
                        <div id="quarterlyAgentChallenge" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    </div>

                    <!-- Admin Travel Challenge -->
                    <div id="adminTravelChallenge" class="hidden bg-white shadow-md rounded-xl p-4 sm:p-6 mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Travel Challenge (Stamping Charges)</h2>
                        <div id="travelChallenge" class="max-h-80 overflow-y-auto space-y-3 challenge-scroll pr-2"></div>
                    </div>

                    <!-- Performance Card(s) -->
                    <div id="agencyListContainer" class="bg-white shadow-md rounded-xl p-4 sm:p-6">
                         <h2 id="agencyListTitle" class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Agency Performance</h2>
                        <div id="data" class="max-h-96 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 pr-2">
                            <!-- Performance cards will be inserted here -->
                        </div>
                    </div>

                    <!-- User Challenges -->
                     <div id="userChallengeContainer" class="hidden mt-6 space-y-6">
                        <div class="bg-white shadow-md rounded-xl p-4 sm:p-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Your Annual Challenge (Best File)</h2>
                            <div id="userAnnualChallenge"></div>
                        </div>
                        <div class="bg-white shadow-md rounded-xl p-4 sm:p-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Your Quarterly Challenge (Total Files)</h2>
                            <div id="userQuarterlyChallenge" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                        </div>
                         <div class="bg-white shadow-md rounded-xl p-4 sm:p-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-slate-800 mb-4">Your Travel Challenge (Stamping Charges)</h2>
                            <div id="userTravelChallenge"></div>
                        </div>
                    </div>
                </div>
            </div>
             <p class="text-center text-xs text-slate-400 mt-8">Powered by RBX</p>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modalTitle" class="text-xl sm:text-2xl font-bold text-slate-800">File Details</h2>
                <button id="closeModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-2 sm:p-6 overflow-y-auto">
                <div class="overflow-x-auto">
                    <table id="detailsTable" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50"><tr><th class="th">Ref Num</th><th class="th">Client Name</th><th class="th">Prop Address</th><th class="th">Values</th></tr></thead>
                        <tbody id="detailsTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let allRecords = [];
        let travelRecords = [];
        let loggedInUser = null;

        // --- DOM Elements ---
        const loginView = document.getElementById('loginView'), dashboardView = document.getElementById('dashboardView');
        const emailInput = document.getElementById('emailInput'), loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn'), loginError = document.getElementById('loginError');
        const dashboardTitle = document.getElementById('dashboardTitle'), welcomeMessage = document.getElementById('welcomeMessage');
        const userControls = document.getElementById('userControls'), selector = document.getElementById('selector');
        const loading = document.getElementById('loading'), errorContainer = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage'), dataContainer = document.getElementById('data');
        const mainContent = document.getElementById('mainContent'), quarterlyContainer = document.getElementById('quarterlyContainer');
        const quarterlyAnalysis = document.getElementById('quarterlyAnalysis'), quarterlyTitle = document.getElementById('quarterlyTitle');
        const adminSummary = document.getElementById('adminSummary'), adminLeaderboard = document.getElementById('adminLeaderboard');
        const agencyListContainer = document.getElementById('agencyListContainer'), agencyListTitle = document.getElementById('agencyListTitle');
        const adminChallenge = document.getElementById('adminChallenge'), agentChallenge = document.getElementById('agentChallenge');
        const adminQuarterlyChallenge = document.getElementById('adminQuarterlyChallenge'), quarterlyAgentChallenge = document.getElementById('quarterlyAgentChallenge');
        const adminTravelChallenge = document.getElementById('adminTravelChallenge'), travelChallenge = document.getElementById('travelChallenge');
        const userChallengeContainer = document.getElementById('userChallengeContainer'), userAnnualChallenge = document.getElementById('userAnnualChallenge'), userQuarterlyChallenge = document.getElementById('userQuarterlyChallenge'), userTravelChallenge = document.getElementById('userTravelChallenge');
        const topAgencies = document.getElementById('topAgencies'), topQuarters = document.getElementById('topQuarters'), topMonths = document.getElementById('topMonths');
        const modal = document.getElementById('detailsModal'), modalTitle = document.getElementById('modalTitle');
        const closeModalBtn = document.getElementById('closeModalBtn'), detailsTableBody = document.getElementById('detailsTableBody');

        // --- URL for the deployed Google Apps Script ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgyQ7yfbckJQHHZefx-K8lXss-LaowhswaT9cis6YVokKouJW_QWZJqV9hmW-nZ80X/exec';

        // --- Core Functions ---
        async function handleLogin() {
            const email = emailInput.value.trim().toLowerCase();
            if (!email) { showLoginError("Please enter an email address."); return; }
            setLoginButtonState(true);
            try {
                const url = `${APPS_SCRIPT_URL}?action=login&email=${encodeURIComponent(email)}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && result.data.agency) {
                    loggedInUser = { email: email, agency: result.data.agency };
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    await showDashboard();
                } else {
                    throw new Error(result.message || "Login failed.");
                }
            } catch (err) {
                showLoginError("Failed to fetch. Please check the App Script URL and deployment settings.");
            } finally {
                setLoginButtonState(false);
            }
        }

        function handleLogout() {
            loggedInUser = null;
            sessionStorage.removeItem('loggedInUser');
            showLoginView();
        }

        async function showDashboard() {
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            await loadDashboardData();
        }

        function showLoginView() {
            dashboardView.classList.add('hidden');
            loginView.classList.remove('hidden');
            emailInput.value = '';
        }

        async function loadDashboardData() {
            loading.classList.remove('hidden');
            mainContent.classList.add('hidden');
            errorContainer.classList.add('hidden');
            try {
                const url = `${APPS_SCRIPT_URL}?action=getData&agency=${encodeURIComponent(loggedInUser.agency)}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success') {
                    allRecords = Array.isArray(result.data.performanceData) ? result.data.performanceData : [];
                    travelRecords = Array.isArray(result.data.travelData) ? result.data.travelData : [];
                    setupDashboard();
                    mainContent.classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'Failed to load data.');
                }
            } catch (err) {
                showError(err.message);
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        function setupDashboard() {
            // Hide all sections by default
            [adminSummary, adminLeaderboard, quarterlyContainer, agencyListContainer, adminChallenge, adminQuarterlyChallenge, adminTravelChallenge, userChallengeContainer].forEach(el => el.classList.add('hidden'));

            if (loggedInUser.agency === 'ADMIN') {
                welcomeMessage.textContent = "Welcome, Admin!";
                dashboardTitle.textContent = "All Agencies Overview";
                userControls.classList.remove('hidden');
                selector.classList.add('hidden');
                updateAdminDisplay();
            } else {
                welcomeMessage.textContent = `Welcome, ${loggedInUser.agency}!`;
                dashboardTitle.textContent = "Performance";
                userControls.classList.remove('hidden');
                selector.classList.remove('hidden');
                populateAgentSelector(allRecords);
                updateUserDisplay();
            }
        }

        function updateUserDisplay() {
            const selectedAgent = selector.value;
            const filteredRecords = selectedAgent === 'All Agents' 
                ? allRecords 
                : allRecords.filter(rec => rec.agents === selectedAgent);
            
            const filteredTravelRecords = selectedAgent === 'All Agents'
                ? travelRecords
                : travelRecords.filter(rec => rec.agents === selectedAgent);

            agencyListTitle.textContent = "Performance Breakdown";
            dataContainer.className = "grid grid-cols-1 gap-6";
            displayPerformanceCard(filteredRecords, selectedAgent, false);
            quarterlyTitle.textContent = `Quarterly Analysis for ${selectedAgent}`;
            displayQuarterlyAnalysis(filteredRecords);
            
            // Show user-specific sections
            displayUserAnnualChallenge(filteredRecords);
            displayUserQuarterlyChallenge(filteredRecords);
            displayUserTravelChallenge(filteredTravelRecords);
            userChallengeContainer.classList.remove('hidden');
            quarterlyContainer.classList.remove('hidden');
            agencyListContainer.classList.remove('hidden');
        }

        function updateAdminDisplay() {
            const currentYear = new Date().getFullYear();
            const yearlyRecords = allRecords.filter(rec => rec.submission_date && new Date(rec.submission_date).getFullYear() === currentYear);

            const totalYearlyFiles = yearlyRecords.length;
            const totalYearlyAmount = yearlyRecords.reduce((sum, record) => sum + (record.la_pp || 0), 0);

            adminSummary.innerHTML = `
                <div class="bg-blue-600 text-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg sm:text-xl font-bold truncate">Total Performance (${currentYear})</h3>
                    <div class="mt-4 flex flex-col sm:flex-row justify-between sm:items-baseline gap-2">
                        <div class="text-center sm:text-left">
                            <p class="text-4xl sm:text-5xl font-extrabold">${totalYearlyFiles}</p>
                            <p class="opacity-80 text-sm mt-1">Total File(s) This Year</p>
                        </div>
                        <div class="text-center sm:text-right">
                             <p class="text-xl sm:text-2xl font-bold">${formatCurrency(totalYearlyAmount)}</p>
                             <p class="opacity-80 text-sm mt-1">Total Values This Year</p>
                        </div>
                    </div>
                </div>
            `;
            
            const agencies = [...new Set(allRecords.map(rec => rec.agency_bank).filter(Boolean))].sort();
            agencyListTitle.textContent = "Individual Agency Performance";
            dataContainer.className = "grid grid-cols-1 md:grid-cols-2 gap-6 pr-2";
            dataContainer.innerHTML = '';
            agencies.forEach(agency => {
                const agencyRecords = allRecords.filter(rec => rec.agency_bank === agency);
                displayPerformanceCard(agencyRecords, agency, true);
            });
            
            quarterlyTitle.textContent = `Quarterly Analysis (All Agencies)`;
            displayQuarterlyAnalysis(allRecords);
            displayLeaderboard(yearlyRecords);
            displayChallengeTracker(yearlyRecords);
            displayQuarterlyChallenge(yearlyRecords);
            displayAdminTravelChallenge(travelRecords);
            
            // Show all admin sections
            [adminSummary, quarterlyContainer, adminLeaderboard, adminChallenge, adminQuarterlyChallenge, adminTravelChallenge, agencyListContainer].forEach(el => el.classList.remove('hidden'));
        }

        // --- UI and Helper Functions ---
        function populateAgentSelector(records) {
            const agents = [...new Set(records.map(rec => rec.agents).filter(Boolean))].sort();
            selector.innerHTML = '<option>All Agents</option>';
            agents.forEach(agent => {
                selector.innerHTML += `<option value="${agent}">${agent}</option>`;
            });
        }
        
        function formatCurrency(number) {
            const numericValue = typeof number === 'number' ? number : 0;
            return new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(numericValue);
        }

        function displayPerformanceCard(records, name, isClickable) {
            const totalFiles = records.length;
            const totalAmount = records.reduce((sum, record) => sum + (record.la_pp || 0), 0);
            const card = document.createElement('div');
            card.className = "bg-white p-4 sm:p-6 rounded-xl shadow-md";
            if (isClickable) {
                card.classList.add("hover:shadow-lg", "hover:-translate-y-1", "transition-all", "duration-300", "cursor-pointer");
                card.onclick = () => showDetails(name, null);
            }

            card.innerHTML = `
                <h3 class="text-lg sm:text-xl font-bold text-slate-800 truncate">${name}</h3>
                <div class="mt-4 flex flex-col sm:flex-row justify-between sm:items-baseline gap-2">
                    <div class="text-center sm:text-left">
                        <p class="text-4xl sm:text-5xl font-extrabold text-blue-600">${totalFiles}</p>
                        <p class="text-slate-500 text-sm mt-1">File(s)</p>
                    </div>
                    <div class="text-center sm:text-right">
                         <p class="text-xl sm:text-2xl font-bold text-green-600">${formatCurrency(totalAmount)}</p>
                         <p class="text-slate-500 text-sm mt-1">Total Values</p>
                    </div>
                </div>`;
            
            if(isClickable) {
                dataContainer.appendChild(card);
            } else {
                dataContainer.innerHTML = '';
                dataContainer.appendChild(card);
            }
        }

        function displayQuarterlyAnalysis(records) {
            const quarters = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
            const currentYear = new Date().getFullYear();
            records.forEach(rec => {
                if (rec.submission_date) {
                    const date = new Date(rec.submission_date);
                    if (date.getFullYear() === currentYear) {
                        const month = date.getMonth();
                        if (month < 3) quarters.Q1++;
                        else if (month < 6) quarters.Q2++;
                        else if (month < 9) quarters.Q3++;
                        else quarters.Q4++;
                    }
                }
            });
            quarterlyAnalysis.innerHTML = Object.entries(quarters).map(([q, count]) => `
                <div class="bg-slate-50 p-3 sm:p-4 rounded-lg hover:bg-slate-200 cursor-pointer transition" onclick="showDetails(null, '${q}')">
                    <div class="text-slate-500 font-bold text-sm sm:text-base">${q}</div>
                    <div class="text-2xl sm:text-3xl font-bold text-slate-800 mt-2">${count}</div>
                </div>`).join('');
        }

        function displayLeaderboard(records) {
            // Top 3 Agencies Overall
            const agencyCounts = records.reduce((acc, rec) => {
                acc[rec.agency_bank] = (acc[rec.agency_bank] || 0) + 1;
                return acc;
            }, {});
            const sortedAgencies = Object.entries(agencyCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
            topAgencies.innerHTML = sortedAgencies.map(([name, count]) => `
                <li class="bg-slate-50 p-3 rounded-md flex justify-between items-center">
                    <span class="font-semibold text-slate-700">${name}</span>
                    <span class="font-bold text-blue-600">${count} files</span>
                </li>`).join('');

            // Top Quarterly Performers
            const quarterCounts = { Q1: {}, Q2: {}, Q3: {}, Q4: {} };
            records.forEach(rec => {
                if (rec.submission_date) {
                    const month = new Date(rec.submission_date).getMonth();
                    let q;
                    if (month < 3) q = 'Q1';
                    else if (month < 6) q = 'Q2';
                    else if (month < 9) q = 'Q3';
                    else q = 'Q4';
                    quarterCounts[q][rec.agency_bank] = (quarterCounts[q][rec.agency_bank] || 0) + 1;
                }
            });
            topQuarters.innerHTML = Object.entries(quarterCounts).map(([q, agencies]) => {
                const top = Object.entries(agencies).sort((a, b) => b[1] - a[1])[0];
                return top ? `<li class="bg-slate-50 p-3 rounded-md flex justify-between items-center">
                                        <span class="font-semibold text-slate-700">${q}: ${top[0]}</span>
                                        <span class="font-bold text-blue-600">${top[1]} files</span>
                                      </li>` : '';
            }).join('');

            // Top Monthly Performers
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const monthCounts = {};
            records.forEach(rec => {
                if (rec.submission_date) {
                    const monthIndex = new Date(rec.submission_date).getMonth();
                    if (!monthCounts[monthIndex]) monthCounts[monthIndex] = {};
                    monthCounts[monthIndex][rec.agency_bank] = (monthCounts[monthIndex][rec.agency_bank] || 0) + 1;
                }
            });
            topMonths.innerHTML = Object.entries(monthCounts).map(([monthIndex, agencies]) => {
                 const top = Object.entries(agencies).sort((a, b) => b[1] - a[1])[0];
                 return top ? `<li class="bg-slate-50 p-3 rounded-md flex justify-between items-center">
                                        <span class="font-semibold text-slate-700">${monthNames[monthIndex]}: ${top[0]}</span>
                                        <span class="font-bold text-blue-600">${top[1]} files</span>
                                       </li>` : '';
            }).join('');
        }

        function displayChallengeTracker(records) {
            const tiers = [
                { value: 1000000, reward: 1000 },
                { value: 1500000, reward: 1500 },
                { value: 2000000, reward: 2000 },
                { value: 2500000, reward: 2500 },
            ];

            const getReward = (value) => {
                let reward = 0;
                for (const tier of tiers) {
                    if (value >= tier.value) {
                        reward = tier.reward;
                    } else {
                        break;
                    }
                }
                return reward;
            };

            const renderWinner = (agentName, agency, record) => {
                const reward = getReward(record.la_pp);
                return `
                    <div class="bg-slate-50 p-3 rounded-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-slate-800">${agentName} <span class="text-xs text-slate-400">(${agency})</span></p>
                                <p class="text-xs text-slate-500 mt-1">File: ${record.ref_num} (${record.client_name})</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600">${formatCurrency(reward)}</p>
                                <p class="text-xs text-slate-500 mt-1">Value: ${formatCurrency(record.la_pp)}</p>
                            </div>
                        </div>
                    </div>`;
            };

            const agentData = records.reduce((acc, rec) => {
                if (rec.agents && rec.la_pp >= tiers[0].value) {
                    if (!acc[rec.agents] || (rec.la_pp || 0) > (acc[rec.agents].la_pp || 0)) {
                        acc[rec.agents] = rec;
                    }
                }
                return acc;
            }, {});

            const winners = Object.values(agentData);
            if (winners.length > 0) {
                agentChallenge.innerHTML = winners
                    .sort((a, b) => (b.la_pp || 0) - (a.la_pp || 0))
                    .map(record => renderWinner(record.agents, record.agency_bank, record))
                    .join('');
            } else {
                agentChallenge.innerHTML = `<p class="text-center text-slate-500 p-4">No agents have qualified for the challenge yet.</p>`;
            }
        }

        function displayQuarterlyChallenge(records) {
            const tiers = [
                { files: 5, reward: 1500 },
                { files: 10, reward: 3000 },
                { files: 15, reward: 4500 },
                { files: 20, reward: 6000 },
            ];
            
            const getReward = (fileCount) => {
                let reward = 0;
                for (const tier of tiers) {
                    if (fileCount >= tier.files) {
                        reward = tier.reward;
                    } else {
                        break;
                    }
                }
                return reward;
            };

            const quarterData = { Q1: {}, Q2: {}, Q3: {}, Q4: {} };
            records.forEach(rec => {
                if (rec.submission_date && rec.agents) {
                    const month = new Date(rec.submission_date).getMonth();
                    let q;
                    if (month < 3) q = 'Q1';
                    else if (month < 6) q = 'Q2';
                    else if (month < 9) q = 'Q3';
                    else q = 'Q4';

                    if (!quarterData[q][rec.agents]) {
                        quarterData[q][rec.agents] = { count: 0, agency: rec.agency_bank };
                    }
                    quarterData[q][rec.agents].count++;
                }
            });

            quarterlyAgentChallenge.innerHTML = Object.entries(quarterData).map(([q, agents]) => {
                const winners = Object.entries(agents).filter(([name, data]) => data.count >= tiers[0].files);
                let content = `<div class="space-y-3"><h3 class="font-bold text-slate-600 text-center">${q} Winners</h3>`;
                if (winners.length > 0) {
                    content += winners.sort((a,b) => b[1].count - a[1].count).map(([name, data]) => {
                        const reward = getReward(data.count);
                        return `
                        <div class="bg-slate-50 p-3 rounded-md">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-slate-800">${name} <span class="text-xs text-slate-400">(${data.agency})</span></p>
                                <p class="font-bold text-green-600">${formatCurrency(reward)}</p>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">${data.count} files</p>
                        </div>`;
                    }).join('');
                } else {
                    content += `<p class="text-center text-slate-400 text-sm p-3">No winners for this quarter.</p>`;
                }
                content += `</div>`;
                return content;
            }).join('');
        }

        function displayAdminTravelChallenge(records) {
            const agentCharges = records.reduce((acc, rec) => {
                if (rec.agents) {
                    if (!acc[rec.agents]) {
                        acc[rec.agents] = { totalCharge: 0, agency: rec.agency_bank };
                    }
                    acc[rec.agents].totalCharge += (rec.charge || 0);
                }
                return acc;
            }, {});

            const sortedAgents = Object.entries(agentCharges).sort((a, b) => b[1].totalCharge - a[1].totalCharge);

            if (sortedAgents.length > 0) {
                travelChallenge.innerHTML = sortedAgents.map(([agentName, data]) => `
                    <div class="bg-slate-50 p-3 rounded-md">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-slate-800">${agentName} <span class="text-xs text-slate-400">(${data.agency})</span></p>
                            <p class="font-bold text-purple-600">${formatCurrency(data.totalCharge)}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                travelChallenge.innerHTML = `<p class="text-center text-slate-500 p-4">No stamping charges recorded yet.</p>`;
            }
        }
        
        function showDetails(entityName, quarter) {
            let records;
            let title;

            if (loggedInUser.agency === 'ADMIN') {
                records = entityName ? allRecords.filter(rec => rec.agency_bank === entityName) : allRecords;
                title = entityName || "All Agencies";
            } else {
                const selectedAgent = selector.value;
                records = selectedAgent === 'All Agents' ? allRecords : allRecords.filter(rec => rec.agents === selectedAgent);
                title = selectedAgent;
            }

            if (quarter) {
                const currentYear = new Date().getFullYear();
                records = records.filter(rec => {
                    if (!rec.submission_date) return false;
                    const date = new Date(rec.submission_date);
                    if (date.getFullYear() !== currentYear) return false;
                    const month = date.getMonth();
                    if (quarter === 'Q1' && month < 3) return true;
                    if (quarter === 'Q2' && month >= 3 && month < 6) return true;
                    if (quarter === 'Q3' && month >= 6 && month < 9) return true;
                    if (quarter === 'Q4' && month >= 9) return true;
                    return false;
                });
                title += ` - ${quarter} Details`;
            } else {
                 title += ' - File Details';
            }
            
            modalTitle.textContent = title;
            detailsTableBody.innerHTML = records.length ? records.map(rec => `
                <tr>
                    <td class="td">${rec.ref_num || 'N/A'}</td>
                    <td class="td-wrap">${rec.client_name || 'N/A'}</td>
                    <td class="td">${rec.prop_address || 'N/A'}</td>
                    <td class="td">${formatCurrency(rec.la_pp)}</td>
                </tr>`).join('') : '<tr><td colspan="4" class="text-center p-4">No files found for this selection.</td></tr>';
            modal.classList.remove('hidden');
        }

        function setLoginButtonState(isLoggingIn) {
            loginBtn.disabled = isLoggingIn;
            loginBtn.textContent = isLoggingIn ? 'Logging in...' : 'Login';
        }
        
        function showLoginError(message) { loginError.textContent = message; loginError.classList.remove('hidden'); }
        function showError(message) { errorMessage.textContent = message; errorContainer.classList.remove('hidden'); }
        function hideDetails() { modal.classList.add('hidden'); }

        // --- App Initialization ---
        function initializeApp() {
            const savedUser = sessionStorage.getItem('loggedInUser');
            if (savedUser) {
                loggedInUser = JSON.parse(savedUser);
                showDashboard();
            } else {
                showLoginView();
            }
        }
        
        function getQuarter(date) {
            const month = date.getMonth();
            if (month < 3) return 'Q1';
            if (month < 6) return 'Q2';
            if (month < 9) return 'Q3';
            return 'Q4';
        }

        function displayUserAnnualChallenge(records) {
             const tiers = [
                { value: 1000000, reward: 1000 },
                { value: 1500000, reward: 1500 },
                { value: 2000000, reward: 2000 },
                { value: 2500000, reward: 2500 },
            ];
            const bestFile = records.reduce((max, file) => ((file.la_pp || 0) > (max.la_pp || 0) ? file : max), { la_pp: 0 });

            let highestTier = null;
            let nextTier = tiers[0];
            for (const tier of tiers) {
                if (bestFile.la_pp >= tier.value) {
                    highestTier = tier;
                } else {
                    nextTier = tier;
                    break;
                }
            }
            if (bestFile.la_pp >= tiers[tiers.length - 1].value) nextTier = null;
            
            const progress = nextTier ? (bestFile.la_pp / nextTier.value) * 100 : 100;

            userAnnualChallenge.innerHTML = `
                <div class="bg-slate-50 p-3 rounded-md">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-slate-700 text-sm">Your Progress</span>
                        <span class="font-bold text-green-600 text-sm">${highestTier ? `Reward: ${formatCurrency(highestTier.reward)}` : 'No Reward Yet'}</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1 text-right">
                        ${nextTier ? `Current Best: ${formatCurrency(bestFile.la_pp)} / ${formatCurrency(nextTier.value)}` : 'Max Goal Reached!'}
                    </div>
                </div>`;
        }
        
        function displayUserQuarterlyChallenge(records) {
            const tiers = [
                { files: 5, reward: 1500 },
                { files: 10, reward: 3000 },
                { files: 15, reward: 4500 },
                { files: 20, reward: 6000 },
            ];
            const currentYear = new Date().getFullYear();
            const quarterIndexes = { Q1: 0, Q2: 1, Q3: 2, Q4: 3 };
            const currentQuarter = getQuarter(new Date());
            const currentQuarterIndex = quarterIndexes[currentQuarter];
            
            const quarterFileCounts = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
            records.forEach(rec => {
                if (rec.submission_date) {
                    const date = new Date(rec.submission_date);
                    if (date.getFullYear() === currentYear) {
                        const q = getQuarter(date);
                        quarterFileCounts[q]++;
                    }
                }
            });

            userQuarterlyChallenge.innerHTML = Object.entries(quarterFileCounts).map(([q, fileCount]) => {
                const qIndex = quarterIndexes[q];
                
                if (qIndex < currentQuarterIndex) {
                    // Past Quarter
                    const reward = tiers.filter(t => fileCount >= t.files).pop()?.reward || 0;
                     return `
                        <div class="bg-slate-50 p-3 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-slate-700 text-sm">${q} (Completed)</span>
                                <span class="font-bold ${reward > 0 ? 'text-green-600' : 'text-slate-500'} text-sm">${reward > 0 ? `Reward: ${formatCurrency(reward)}` : 'No Reward'}</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">${fileCount} files submitted</p>
                        </div>`;
                } else if (qIndex === currentQuarterIndex) {
                    // Current Quarter
                    let highestTier = null;
                    let nextTier = tiers[0];
                    for (const tier of tiers) {
                        if (fileCount >= tier.files) { highestTier = tier; } 
                        else { nextTier = tier; break; }
                    }
                    if (fileCount >= tiers[tiers.length - 1].files) nextTier = null;
                    const progress = nextTier ? (fileCount / nextTier.files) * 100 : 100;
                    return `
                        <div class="bg-slate-50 p-3 rounded-md">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold text-slate-700 text-sm">Your Progress (${q})</span>
                                <span class="font-bold text-green-600 text-sm">${highestTier ? `Reward: ${formatCurrency(highestTier.reward)}` : 'No Reward Yet'}</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>
                            <div class="text-xs text-slate-500 mt-1 text-right">${nextTier ? `Current: ${fileCount} files / ${nextTier.files} files` : 'Max Goal Reached!'}</div>
                        </div>`;
                } else {
                    // Future Quarter
                    return `
                        <div class="bg-slate-50 p-3 rounded-md opacity-60">
                             <div class="flex justify-between items-center">
                                <span class="font-semibold text-slate-700 text-sm">${q} (Upcoming)</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Challenge has not started yet.</p>
                        </div>`;
                }
            }).join('');
        }

        function displayUserTravelChallenge(records) {
            const travelGoal = 5000; // Let's set a goal of RM 5000
            const totalCharge = records.reduce((sum, rec) => sum + (rec.charge || 0), 0);
            const progress = (totalCharge / travelGoal) * 100;

            userTravelChallenge.innerHTML = `
                <div class="bg-slate-50 p-3 rounded-md">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-slate-700 text-sm">Your Progress</span>
                        <span class="font-bold text-purple-600 text-sm">${totalCharge >= travelGoal ? 'Goal Reached!' : 'Keep Going!'}</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress > 100 ? 100 : progress}%"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1 text-right">
                        Total Charges: ${formatCurrency(totalCharge)} / ${formatCurrency(travelGoal)}
                    </div>
                </div>
            `;
        }

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        selector.addEventListener('change', () => {
             if (loggedInUser.agency === 'ADMIN') {
                 updateAdminDisplay();
             } else {
                 updateUserDisplay();
             }
        });
        closeModalBtn.addEventListener('click', hideDetails);
        modal.addEventListener('click', (e) => { if (e.target === modal) hideDetails(); });
        emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
